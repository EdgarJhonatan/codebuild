version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "▶ Instalando dependencias..."
      - npm install -g serverless@3.38.0
      - npm install

      - echo "▶ Inicializando repo Git temporal..."
      - git init
      - git add .

      - echo "▶ Instalando git-secrets..."
      - git clone https://github.com/awslabs/git-secrets.git
      - cd git-secrets && make install && cd ..

      - echo "▶ Configurando git-secrets..."
      - git secrets --install
      - git secrets --register-aws
  build:
    commands:
      - echo "▶ Ejecutando análisis de secretos..."
      - git secrets --scan || exit 1

      - echo "▶ Desplegando Lambda con Serverless..."
      - sls deploy --stage dev