version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "‚ñ∂ Instalando dependencias..."
      - npm install -g serverless@3.38.0
      - npm install

      - echo "‚ñ∂ Inicializando repositorio Git temporal..."
      - git init
      - git config user.email "codebuild@example.com"
      - git config user.name "AWS CodeBuild"
      - git add .
      - git commit -m "scan commit" || true

      - echo "‚ñ∂ Instalando git-secrets..."
      - git clone https://github.com/awslabs/git-secrets.git
      - cd git-secrets && make install && cd ..

      - echo "‚ñ∂ Configurando git-secrets..."
      - git secrets --install
      - git secrets --register-aws

      - echo "‚ñ∂ Instalando Trivy..."
      - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
      - cp ./bin/trivy /usr/local/bin/

      - echo "‚ñ∂ Instalando Checkov..."
      - pip install checkov

  build:
    commands:
      - echo "‚ñ∂ Ejecutando an√°lisis de secretos con git-secrets..."
      - git secrets --scan $(find . -type f -name '*.js') || { echo '‚ùå Se detectaron secretos embebidos.'; exit 1; }

      - echo "‚ñ∂ Ejecutando escaneo de vulnerabilidades con Trivy (modo inteligente)..."
      - |
        if [ -f "package-lock.json" ] || [ -f "yarn.lock" ] || [ -f "npm-shrinkwrap.json" ]; then
          echo "üü¢ Proyecto Node.js detectado"
          trivy fs --exit-code 1 --scanners vuln --severity HIGH,CRITICAL .
        elif [ -f "pom.xml" ]; then
          echo "üü† Proyecto Java detectado (Maven)"
          trivy fs --exit-code 1 --scanners vuln --severity HIGH,CRITICAL .
        elif [ -f "requirements.txt" ]; then
          echo "üîµ Proyecto Python detectado"
          trivy fs --exit-code 1 --scanners vuln --severity HIGH,CRITICAL .
        else
          echo "‚ö†Ô∏è No se detect√≥ lenguaje compatible. Escaneo gen√©rico con Trivy..."
          trivy fs --exit-code 1 --scanners vuln --severity HIGH,CRITICAL .
        fi

      - echo "‚ñ∂ Detectando tipo de proyecto..."
      - |
        if [ -f "serverless.yml" ]; then
          echo "üì¶ Proyecto Serverless Framework detectado"
        fi

        if [ -f "Dockerfile" ]; then
          echo "üê≥ Proyecto Docker detectado (solo detecci√≥n, sin escaneo de imagen a√∫n)"
        fi

        if find . -name "*.tf" -o -name "*.yml" -o -name "*.yaml" -o -name "*.json" | grep -q .; then
          echo "üèóÔ∏è Proyecto IaC detectado (YAML, JSON o Terraform)"
          echo "üßπ Limpiando carpetas temporales para evitar falsos positivos..."
          rm -rf git-secrets
          echo "‚ñ∂ Ejecutando an√°lisis con Checkov..."
          checkov -d . --quiet --soft-fail
        fi

  post_build:
    commands:
      - echo "‚úÖ Validaciones finalizadas. Listo para revisi√≥n del PR."

      - echo "üì¶ Generando resumen JSON para trazabilidad..."
      - echo "{" > build-validate.json
      - echo "  \"repository\": \"${CODEBUILD_SOURCE_REPO_URL}\"," >> build-validate.json
      - echo "  \"branch\": \"${CODEBUILD_WEBHOOK_HEAD_REF}\"," >> build-validate.json
      - echo "  \"commit\": \"${CODEBUILD_RESOLVED_SOURCE_VERSION}\"," >> build-validate.json
      - echo "  \"status\": \"${CODEBUILD_BUILD_SUCCEEDING}\"," >> build-validate.json
      - echo "  \"stage\": \"validate\"," >> build-validate.json
      - echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> build-validate.json
      - echo "}" >> build-validate.json

      - echo "‚òÅÔ∏è Subiendo a S3: s3://cb-logs-delga/validate/build-validate-${CODEBUILD_BUILD_ID}.json"
      - aws s3 cp build-validate.json s3://cb-logs-delga/validate/build-validate-${CODEBUILD_BUILD_ID}.json