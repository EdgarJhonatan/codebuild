version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "‚ñ∂ Instalando dependencias del proyecto..."
      - npm install

      - echo "‚ñ∂ Inicializando repositorio Git temporal..."
      - git init
      - git add .
      - git commit -m "scan commit" || true

      - echo "‚ñ∂ Instalando git-secrets..."
      - git clone https://github.com/awslabs/git-secrets.git
      - cd git-secrets && make install && cd ..
      - git secrets --install
      - git secrets --register-aws

      - echo "‚ñ∂ Instalando Trivy..."
      - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
      - mv trivy /usr/local/bin/
      - trivy --version

      - echo "‚ñ∂ Instalando SonarQube Scanner... (comentado por ahora)"
      # - curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
      # - unzip sonar-scanner.zip
      # - export PATH=$PATH:$PWD/sonar-scanner-5.0.1.3006-linux/bin

  build:
    commands:
      - echo "‚ñ∂ Detectando tipo de proyecto..."

      - |
        if [ -f "main.tf" ]; then
          echo "üîç Proyecto IaC (Terraform) detectado"
          trivy config . --exit-code 1 --severity HIGH,CRITICAL

        elif [ -f "Dockerfile" ]; then
          echo "üê≥ Docker detectado (comentado por ahora)"
          # docker build -t myimage .
          # trivy image myimage --exit-code 1 --severity HIGH,CRITICAL

        elif [ -f "serverless.yml" ]; then
          echo "‚ö° Proyecto Serverless (Lambda) detectado"
          echo "‚ñ∂ Ejecutando git-secrets..."
          git secrets --scan $(find . -type f -name '*.js') || {
            echo '‚ùå Se detectaron secretos embebidos.'; exit 1;
          }

          echo "‚ñ∂ Ejecutando Trivy sobre el filesystem..."
          trivy fs . --exit-code 1 --severity HIGH,CRITICAL

          echo "‚ñ∂ Ejecutando SonarQube Scanner... (comentado)"
          # sonar-scanner

        else
          echo "‚ùå Tipo de proyecto no reconocido. Abortando..."
          exit 1
